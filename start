#!/bin/bash

# Prepare Django by migrating and collecting static files
python3 /var/shrubbery/2023/manage.py migrate --no-input
python3 /var/shrubbery/2023/manage.py collectstatic --noinput --clear
python3 /var/shrubbery/2024/manage.py migrate --no-input
python3 /var/shrubbery/2024/manage.py collectstatic --noinput --clear

# Run Redis and Celery
redis-server --daemonize yes
celery -A shrubbery worker -l DEBUG --logfile=celery_worker.log --detach
celery -A shrubbery beat -l DEBUG --logfile=celery_beat.log --detach

# Start Gunicorn + Nginx
gunicorn -c 2023/gunicorn_conf_2023.py
gunicorn -c 2024/gunicorn_conf_2024.py
nginx -g 'daemon off;'
